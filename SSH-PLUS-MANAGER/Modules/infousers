#!/usr/bin/env python3
import os
import pwd
import subprocess
import time
from datetime import datetime
import psutil

# --- Configuration ---
USERS_DB = "/root/users.db"
PASSWORD_DIR = "/etc/SSHPlus/senha/"
OPENVPN_STATUS_LOG = "/etc/openvpn/openvpn-status.log"

COLOR_RESET = "\033[0m"
COLOR_YELLOW = "\033[1;33m"
COLOR_GREEN = "\033[1;32m"
COLOR_RED = "\033[1;31m"
COLOR_CYAN = "\033[1;36m"
COLOR_BLUE = "\033[0;34m"

def get_system_users_data():
    """Retrieves system users with UID >= 1000, excluding 'nobody'."""
    users = {}
    for p in pwd.getpwall():
        if p.pw_uid >= 1000 and p.pw_name != 'nobody':
            users[p.pw_name] = {
                "password": "Null",
                "limit": 1,
                "expiration": "Never",
                "online_connections": 0
            }
    return users

def get_user_limits_from_db():
    """Reads user connection limits from /root/users.db."""
    limits = {}
    if os.path.exists(USERS_DB):
        with open(USERS_DB, 'r') as f:
            for line in f:
                parts = line.strip().split()
                if len(parts) >= 2:
                    limits[parts[0]] = int(parts[1])
    return limits

def get_passwords():
    """Reads plaintext passwords from /etc/SSHPlus/senha/."""
    passwords = {}
    if os.path.exists(PASSWORD_DIR):
        for filename in os.listdir(PASSWORD_DIR):
            filepath = os.path.join(PASSWORD_DIR, filename)
            if os.path.isfile(filepath):
                try:
                    with open(filepath, 'r') as f:
                        passwords[filename] = f.read().strip()
                except Exception:
                    pass
    return passwords

def get_expiration_date(username):
    """Gets account expiration date using chage -l."""
    try:
        result = subprocess.run(['chage', '-l', username], capture_output=True, text=True, check=True)
        for line in result.stdout.splitlines():
            if "Account expires" in line:
                expire_str = line.split(":", 1)[1].strip()
                if expire_str.lower() == 'never':
                    return "Never"
                try:
                    # chage output format varies, try common ones
                    expire_date = datetime.strptime(expire_str, '%b %d, %Y')
                    return expire_date
                except ValueError:
                    try: # Another common format
                        expire_date = datetime.strptime(expire_str, '%Y-%m-%d')
                        return expire_date
                    except ValueError:
                        return expire_str # Return as is if cannot parse
    except (subprocess.CalledProcessError, FileNotFoundError):
        return "Error"
    return "Never" # Default if not found

def get_online_connections():
    """Counts active SSH, OpenVPN, and Dropbear connections."""
    online_counts = {}

    # SSH connections
    for p in psutil.process_iter(['username', 'name', 'cmdline']):
        try:
            username = p.info['username']
            pname = p.info['name']
            cmdline = p.info['cmdline']

            # SSHD user sessions
            if pname == 'sshd' and f"sshd: {username}" in " ".join(cmdline):
                online_counts[username] = online_counts.get(username, 0) + 1
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            continue

    # OpenVPN connections (from status log)
    if os.path.exists(OPENVPN_STATUS_LOG):
        try:
            with open(OPENVPN_STATUS_LOG, 'r') as f:
                content = f.read()
                client_list_match = re.search(r"""CLIENT_LIST(?P<clients>.*?)(?=
ROUTING_TABLE|
GLOBAL_STATS|
\Z)""", content, re.DOTALL | re.MULTILINE)
                if client_list_match:
                    clients_section = client_list_match.group('clients')
                    for line in clients_section.splitlines():
                        parts = line.split(',')
                        if len(parts) >= 1: # CN is usually the username
                            username = parts[0] 
                            online_counts[username] = online_counts.get(username, 0) + 1
        except Exception:
            pass
            
    # Dropbear connections (from 'ps aux') - simplified heuristic
    # Dropbear processes usually show username in 'ps aux' output
    try:
        result = subprocess.run(['ps', 'aux'], capture_output=True, text=True, check=True)
        for line in result.stdout.splitlines():
            if 'dropbear' in line and 'root' not in line: # Exclude root dropbear process itself
                match = re.search(r'\s+([a-zA-Z0-9_]+)\s+.*?dropbear', line)
                if match:
                    username = match.group(1)
                    online_counts[username] = online_counts.get(username, 0) + 1
    except Exception:
        pass


    return online_counts

def main():
    os.system("clear")
    print(f"{COLOR_BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{COLOR_RESET}")
    print(f"{COLOR_YELLOW}User".ljust(15), f"Password".ljust(17), f"Limit".ljust(10), f"Validity{COLOR_RESET}")
    print(f"{COLOR_BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{COLOR_RESET}")

    all_users_data = get_system_users_data()
    user_limits = get_user_limits_from_db()
    user_passwords = get_passwords()
    online_connections = get_online_connections()

    for username, data in all_users_data.items():
        data["password"] = user_passwords.get(username, "Null")
        data["limit"] = user_limits.get(username, 1) # Default to 1 if no limit found
        
        exp_date = get_expiration_date(username)
        data["expiration"] = exp_date

        if isinstance(exp_date, datetime):
            today = datetime.now().date()
            if exp_date.date() <= today:
                data["validity_display"] = f"{COLOR_RED}EXPIRED{COLOR_RESET}"
            else:
                days_left = (exp_date.date() - today).days
                data["validity_display"] = f"{days_left} {COLOR_RESET}Days"
        else:
            data["validity_display"] = f"{COLOR_YELLOW}{exp_date}{COLOR_RESET}"
        
        data["online_connections"] = online_connections.get(username, 0)
        
        # Print row
        print(f"{COLOR_YELLOW}{username.ljust(15)}{COLOR_RESET}",
              f"{data['password'].ljust(17)}{COLOR_RESET}",
              f"{str(data['limit']).ljust(10)}{COLOR_RESET}",
              f"{data['validity_display']}{COLOR_RESET}")
        print(f"{COLOR_BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━{COLOR_RESET}")

    total_system_users = len(all_users_data)
    total_online_users = sum(1 for user_data in all_users_data.values() if user_data["online_connections"] > 0)
    
    # Expired user count from /etc/SSHPlus/Exp (as per bash script)
    expired_users_count = "0"
    if os.path.exists("/etc/SSHPlus/Exp"):
        try:
            with open("/etc/SSHPlus/Exp", 'r') as f:
                expired_users_count = f.read().strip()
        except Exception:
            pass

    print(f"{COLOR_YELLOW}• {COLOR_CYAN}TOTAL USERS{COLOR_RESET}: {total_system_users} {COLOR_YELLOW}• {COLOR_GREEN}ONLINE USERS{COLOR_RESET}: {total_online_users} {COLOR_YELLOW}• {COLOR_RED}EXPIRED USERS{COLOR_RESET}: {expired_users_count} {COLOR_YELLOW}•{COLOR_RESET}")

if __name__ == '__main__':
    main()