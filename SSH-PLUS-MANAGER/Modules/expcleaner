#!/usr/bin/env python3
import os
import subprocess
import re
import shutil
from datetime import datetime

# --- Configuration ---
USERS_DB = "/root/users.db"
PASSWORD_DIR = "/etc/SSHPlus/senha/"
EASYRSA_DIR = "/etc/openvpn/easy-rsa/" # Assuming easy-rsa is installed here
OPENVPN_SERVER_CONFIG = "/etc/openvpn/server.conf"

COLOR_RESET = "\033[0m"
COLOR_YELLOW = "\033[1;33m"
COLOR_GREEN = "\033[1;32m"
COLOR_RED = "\033[1;31m"
COLOR_BOLD = "\033[1m"
COLOR_BG_RED = "\033[41m"
COLOR_FG_WHITE = "\033[37m"

def run_command(command, check=True, capture_output=False):
    """Helper to run shell commands."""
    try:
        result = subprocess.run(command, check=check, capture_output=capture_output, text=True, shell=True)
        return result.stdout.strip() if capture_output else ""
    except subprocess.CalledProcessError as e:
        print(f"{COLOR_RED}Error running command: {command}{COLOR_RESET}")
        print(f"{COLOR_RED}Stdout: {e.stdout}{COLOR_RESET}")
        print(f"{COLOR_RED}Stderr: {e.stderr}{COLOR_RESET}")
        return None
    except FileNotFoundError:
        print(f"{COLOR_RED}Command not found: {command.split()[0]}{COLOR_RESET}")
        return None

def get_system_users():
    """Returns a list of system usernames with UID >= 1000, excluding 'nobody'."""
    users = []
    try:
        result = run_command("awk -F: '$3>=1000 {print $1}' /etc/passwd | grep -v nobody", capture_output=True)
        if result:
            users = result.splitlines()
    except Exception:
        pass
    return users

def get_expiration_date(username):
    """Gets account expiration date using chage -l."""
    try:
        result = run_command(f"chage -l {username}", capture_output=True)
        for line in result.splitlines():
            if "Account expires" in line:
                expire_str = line.split(":", 1)[1].strip()
                if expire_str.lower() == 'never':
                    return "Never"
                try:
                    return datetime.strptime(expire_str, '%b %d, %Y')
                except ValueError:
                    try: # Another common format
                        return datetime.strptime(expire_str, '%Y-%m-%d')
                    except ValueError:
                        return expire_str # Return as is if cannot parse
    except Exception:
        pass
    return "Error"

def remove_openvpn_certs(username):
    """Revokes OpenVPN certificates for the given user using EasyRSA."""
    if not os.path.exists(EASYRSA_DIR) or not os.path.exists(OPENVPN_SERVER_CONFIG):
        return

    print(f"  {COLOR_YELLOW}Revoking OpenVPN certificate for {username}...{COLOR_RESET}")
    # Navigate to EasyRSA directory and execute commands
    try:
        # EasyRSA expects to be run from its directory
        current_dir = os.getcwd()
        os.chdir(EASYRSA_DIR)

        run_command(f"./easyrsa --batch revoke {username}")
        run_command("./easyrsa gen-crl")

        # Copy CRL to OpenVPN config directory
        shutil.copy(os.path.join(EASYRSA_DIR, "pki/crl.pem"), "/etc/openvpn/crl.pem")
        run_command("chown nobody:nogroup /etc/openvpn/crl.pem") # Assuming 'nogroup' or appropriate group

        # Clean up EasyRSA pki files for the user
        run_command(f"rm -rf pki/reqs/{username}.req")
        run_command(f"rm -rf pki/private/{username}.key")
        run_command(f"rm -rf pki/issued/{username}.crt")
        
        # Remove generated .ovpn and .zip files if they exist
        home_dir = os.path.expanduser(f"~{username}") # This might not be the correct home dir for created users
        if os.path.exists(f"/root/{username}.ovpn"):
            os.remove(f"/root/{username}.ovpn")
        if os.path.exists(f"/root/{username}.zip"):
            os.remove(f"/root/{username}.zip")
        if os.path.exists(f"/var/www/html/openvpn/{username}.zip"):
            os.remove(f"/var/www/html/openvpn/{username}.zip")

        print(f"  {COLOR_GREEN}OpenVPN certificate revoked for {username}.{COLOR_RESET}")
    except Exception as e:
        print(f"{COLOR_RED}Failed to revoke OpenVPN certificate for {username}: {e}{COLOR_RESET}")
    finally:
        os.chdir(current_dir) # Change back to original directory


def main():
    os.system("clear")
    print(f"{COLOR_BG_RED}{COLOR_FG_WHITE}{COLOR_BOLD} User          Date         Status         Action    {COLOR_RESET}")
    print()

    current_date = datetime.now().date()
    expired_count = 0
    
    users_to_check = get_system_users()
    
    # Also include users from users.db who might not be system users anymore
    if os.path.exists(USERS_DB):
        with open(USERS_DB, 'r') as f:
            for line in f:
                username = line.strip().split()[0]
                if username not in users_to_check:
                    users_to_check.append(username)

    for username in users_to_check:
        expiration_info = get_expiration_date(username)
        
        status = f"{COLOR_GREEN}VALID"
        action = f"{COLOR_GREEN}NOT REMOVED"
        
        if isinstance(expiration_info, datetime):
            if expiration_info.date() <= current_date:
                status = f"{COLOR_RED}EXPIRED"
                action = f"{COLOR_RED}WAS REMOVED"
                expired_count += 1
                
                print(f"{COLOR_YELLOW}{username.ljust(15)}{COLOR_RESET} {expiration_info.strftime('%d/%m/%Y').ljust(12)} {status.ljust(15)} {action}{COLOR_RESET}")

                # Perform removal actions
                run_command(f"pkill -u {username}") # Kill all processes for the user
                run_command(f"userdel --force {username}") # Delete user account

                # Update users.db
                if os.path.exists(USERS_DB):
                    with open(USERS_DB, 'r') as f_in:
                        lines = f_in.readlines()
                    with open(USERS_DB, 'w') as f_out:
                        for line in lines:
                            if not line.startswith(username + ' '):
                                f_out.write(line)

                # Remove password file
                password_file = os.path.join(PASSWORD_DIR, username)
                if os.path.exists(password_file):
                    os.remove(password_file)
                
                # Revoke OpenVPN certificate if OpenVPN is installed
                remove_openvpn_certs(username)

            else: # User is valid
                print(f"{COLOR_YELLOW}{username.ljust(15)}{COLOR_RESET} {expiration_info.strftime('%d/%m/%Y').ljust(12)} {status.ljust(15)} {action}{COLOR_RESET}")
        else: # "Never" or "Error" expiration
             print(f"{COLOR_YELLOW}{username.ljust(15)}{COLOR_RESET} {str(expiration_info).ljust(12)} {status.ljust(15)} {action}{COLOR_RESET}")

    # Update /etc/SSHPlus/Exp with the count of expired users
    with open("/etc/SSHPlus/Exp", 'w') as f:
        f.write(str(expired_count))
        
    print() # Newline for better formatting

if __name__ == '__main__':
    main()
